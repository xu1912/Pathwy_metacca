#!/bin/bash

###########
##Single pathway analysis
##Input: $1 -- File name containting the SNP list
##
##Requires: up_pro.bed file -- contains the SNP reference information, generated by Plink
##                            plink2 --file hapmap3 --extract totalids.txt --keep CEU_hapmap --indep-pairwise 50 5 0.2 --r2 inter-chr with-freqs --ld-window-r2 0 --make-bed --out uppro
##
##          metacca.db -- sqlite3 database with table snp_traits contains snp and trait information. Each row represents a snp, each column represnts a trait.
##
##Output: two files named with input file name and "r1", "r2" as postfix. "r1" contains the CCA coefficient and -log(p-value) of each SNP; "r2" contains the the CCA coefficient and -log(p-value) of the pathway.
############

KEGG_f=$1
KEGG_n=${KEGG_f%$".txt"}      ###Get pathway name.
echo $KEGG_n
cd /extra/xc/metacca        ###working directory, which contains the required files and "bin" folder.

if [[ ! -f result/$KEGG_n"_r1.txt" || ! -f result/$KEGG_n"_r2.txt"   ]];then
        mkdir -p input
        KEGG_snp=$KEGG_n".snplist"
        if [[ ! -f input/$KEGG_n"_XX.txt" || ! -f input/$KEGG_snp ]];then
                echo "Prepare S_XX..."
                plink2 --silent --bfile up_pro_pruned --extract pathway_checked/$KEGG_f --r square --write-snplist --out input/$KEGG_n
                mv input/$KEGG_n".ld" input/$KEGG_n"_XX.txt"
        fi


        if [ ! -f input/$KEGG_n"_XY.txt" ];then
                cd input
                echo "Prepare S_XY..."
                sqlite3 ../metacca.db "drop table if exists snp_l_$KEGG_n"
                sqlite3 ../metacca.db "create table snp_l_$KEGG_n (snp_n varchar(20))"
                sqlite3 ../metacca.db ".import $KEGG_snp snp_l_$KEGG_n"
                sqlite3 ../metacca.db "select b.snp, b.allele_0, b.allele_1, b.trait1_b_norm, b.trait1_se, b.trait2_b_norm, b.trait2_se, b.trait3_b_norm, b.trait3_se, b.trait4_b_norm, b.trait4_se, b.trait5_b_norm, b.trait5_se,  b.trait7_b_norm, b.trait7_se from snp_l_$KEGG_n a, snp_traits b where a.snp_n=b.SNP" > $KEGG_n"_XY.txt"
                sqlite3 ../metacca.db "drop table snp_l_$KEGG_n"
                echo "metaCCA..."
                Rscript --no-save ../bin/metaCCA.r $KEGG_n
        fi
fi
echo "DONE."
